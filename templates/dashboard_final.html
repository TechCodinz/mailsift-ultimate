<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MailSift Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Dashboard</h1>
            <a href="/" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                <i class="fas fa-arrow-left mr-2"></i>Back to App
            </a>
        </div>
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <i class="fas fa-chart-line text-3xl text-blue-500 mb-2"></i>
                <h3 class="text-gray-500 text-sm">Total Extracted</h3>
                <div class="text-3xl font-bold">{{ user.total_extracted }}</div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6">
                <i class="fas fa-crown text-3xl text-yellow-500 mb-2"></i>
                <h3 class="text-gray-500 text-sm">Current Plan</h3>
                <div class="text-3xl font-bold">{{ user.plan|upper }}</div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6">
                <i class="fas fa-coins text-3xl text-green-500 mb-2"></i>
                <h3 class="text-gray-500 text-sm">Credits</h3>
                <div class="text-3xl font-bold">{{ user.credits }}</div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6">
                <i class="fas fa-rocket text-3xl text-purple-500 mb-2"></i>
                <h3 class="text-gray-500 text-sm">API Calls</h3>
                <div class="text-3xl font-bold">0</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="font-bold mb-4">Extraction History</h3>
                <canvas id="historyChart"></canvas>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="font-bold mb-4">Category Distribution</h3>
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <!-- API Keys -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">API Access</h2>
            {% if user.plan != 'free' %}
                <button onclick="generateKey()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 mb-4">
                    <i class="fas fa-key mr-2"></i>Generate API Key
                </button>
                <div id="api-keys" class="space-y-2"></div>
            {% else %}
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <p class="text-yellow-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        Upgrade to a paid plan to access the API
                    </p>
                    <a href="/pricing" class="text-purple-600 hover:underline mt-2 inline-block">
                        View Plans â†’
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Recent Extractions -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">Recent Extractions</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2">Date</th>
                            <th class="text-left py-2">Emails Found</th>
                            <th class="text-left py-2">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in history %}
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-2">{{ item[1] }}</td>
                            <td class="py-2">{{ item[0] }}</td>
                            <td class="py-2">
                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-sm">Success</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // History Chart
        const historyCtx = document.getElementById('historyChart').getContext('2d');
        new Chart(historyCtx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Emails Extracted',
                    data: [12, 19, 3, 5, 2, 3, 8],
                    borderColor: 'rgb(147, 51, 234)',
                    backgroundColor: 'rgba(147, 51, 234, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Category Chart
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: ['Corporate', 'Personal', 'Education', 'Other'],
                datasets: [{
                    data: [45, 25, 15, 15],
                    backgroundColor: [
                        'rgb(147, 51, 234)',
                        'rgb(236, 72, 153)',
                        'rgb(59, 130, 246)',
                        'rgb(156, 163, 175)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        async function generateKey() {
            const response = await fetch('/api/generate-key', {method: 'POST'});
            const data = await response.json();
            
            if (data.api_key) {
                const keyDiv = document.createElement('div');
                keyDiv.className = 'bg-gray-100 p-3 rounded-lg font-mono text-sm break-all';
                keyDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span>${data.api_key}</span>
                        <button onclick="copyKey('${data.api_key}')" class="text-purple-600 hover:text-purple-700">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                `;
                document.getElementById('api-keys').appendChild(keyDiv);
            } else if (data.error) {
                alert(data.error);
            }
        }

        function copyKey(key) {
            navigator.clipboard.writeText(key);
            alert('API key copied to clipboard!');
        }
    </script>
</body>
</html>
